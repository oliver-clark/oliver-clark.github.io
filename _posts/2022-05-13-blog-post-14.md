---
title: 'Evaluating PRS in R to calculate "Area Under the Curve" and Odds Ratio'
date: 2022-05-13
permalink: /posts/2022/05/blog-post-14/
tags:
  - Penn Medicine Biobank
  - Cancer risk
  - GWAS
  - Polygenic risk score
  - PRS
---

This post shows the initial R script I've written to calculate AUC and OR for the PRS generated in plink in previous blog posts. 

I've pasted the script below and I'll update it a bit later:

```
#!/usr/bin/env Rscript
library(pROC)
library(ggplot2)
library(scales)
library(tidyverse)
library(dplyr)
library(lme4)
library(sjPlot)

# Script takes multiple arguments, all in the form of file paths
# Arg 1: population covariate file location
# Arg 2: PMBB Ids of cancer cases
# Arg 3: PMBB Ids of control cases
# Arg 4: .Profile file generated in plink using OC_build_PRS
# Arg 5: Output filepath and name

# args=commandArgs(trailingOnly = TRUE)

# Temporary args while working on script
args=c("G://My Drive//Work//Research//Maxwell//PMBB_IDs//eur_covariates_pmbb_v2-1.txt","G://My Drive//Work//Research//Maxwell//PMBB_IDs//PMBB_IDs_lung_cases.txt","G://My Drive//Work//Research//Maxwell//PMBB_IDs//PMBB_IDs_control_clean.txt", "G://My Drive//Work//Research//Maxwell//Profiles//European_PRS.profile", "G://My Drive//Work//Research//Maxwell//output.csv")

# read covariates file and name columns 
covariates <- read.csv(file= args[1], header = F, sep="\t")
colnames(covariates) <- c("id", "gender", "birthyear","age","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","PC15","PC16","PC17","PC18","PC19","PC20")

covariates = covariates[covariates$age>=50,]

# Load "cases" PMBB_ID file
case_phenotypes <- read.csv(file= args[2], header = T, sep=",")
colnames(case_phenotypes)[1] = "id"
case_phenotypes$pheno=1

# Load "control" PMBB_ID file
control_phenotypes <- read.csv(file= args[3], header = T, sep=",")
colnames(control_phenotypes)[1] = "id"
control_phenotypes$pheno=0

phenotypes = rbind(case_phenotypes, control_phenotypes)

# genotype file = .profile generated from PLINK
genotypes <- read.csv(file=args[4], header = T, sep = "")
colnames(genotypes)[1:2] <- c("id", "id2")

# scale genotype file 
genotypes_scaled <- data.frame(genotypes[2], (apply(genotypes[6],2,scale)))
colnames(genotypes_scaled)[1] = "id"
colnames(genotypes_scaled)[2] <- "normalizedScore"

# merge genotype file with phenotype file based on id column
score_pheno = merge(genotypes_scaled, phenotypes, by="id")

# merge score_pheno file with covariates based on id column
score_pheno_cov = merge(score_pheno, covariates, by="id")

# Remove incomplete cases
score_pheno_cov <- score_pheno_cov[complete.cases(score_pheno_cov),]

# extract top, bottom, and remaining quintiles
top = which(score_pheno_cov$normalizedScore > quantile(score_pheno_cov$normalizedScore, 0.8))
bottom = which(score_pheno_cov$normalizedScore < quantile(score_pheno_cov$normalizedScore,0.2))
rest = which(score_pheno_cov$normalizedScore <= quantile(score_pheno_cov$normalizedScore, 0.8)) 

# define data frames for top, bottom, and remaining quintiles
top_q = score_pheno_cov[top,]
bot_q = score_pheno_cov[bottom,]
top_bot = c(top_q, bot_q)

# for non-gender specific cancers:
mod <- glm(pheno ~ normalizedScore+gender+age+PC1+PC2+PC3+PC4+PC5+PC6+PC7+PC8+PC9+PC10, family="binomial", data=score_pheno_cov)

# If needed, display summary and table for 'mod'
# summary(mod)
# tab_model(mod)

# AUC calculated using predict() and roc()
predict_mod <- predict(mod,type=c("response"))
roc_mod <- roc(score_pheno_cov$pheno ~ predict_mod)

# AUC model for CI 
auc_mod <-roc(score_pheno_cov$pheno ~ predict_mod, score_pheno_cov, plot=T, ci=T,print.auc = TRUE)

# 95 CI interval for AUC with bootstrapping
CI_bootstrap <- ci.auc(auc_mod, method='bootstrap', n.boot=10000)

# Save output values to variable
AUC <- toString(auc(roc_mod))
AUC_bootstrap <- toString(CI_bootstrap)
odds_ratio = toString(exp(summary(mod)$coefficients[2]))
OR_CI <- paste(exp((summary(mod)$coefficients[2])-1.96*summary(mod)$coefficients[2,2]), "-", exp((summary(mod)$coefficients[2])+1.96*summary(mod)$coefficients[2,2]))

# Create output file that will be written to csv
# 4 Columns labelled for AUC, AUC confidence interval, odds ratio, and odds ratio CI
output = data.frame(AUC=AUC, AUC_CI=AUC_bootstrap, OR=odds_ratio, OR_CI=OR_CI)

# Output to CSV with file path as specified in args
write.csv(output,args[5], row.names = FALSE)
```
