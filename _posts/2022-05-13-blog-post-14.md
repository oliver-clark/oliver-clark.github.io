---
title: 'Evaluating PRS in R to calculate "Area Under the Curve" and Odds Ratio'
date: 2022-05-13
permalink: /posts/2022/05/blog-post-14/
tags:
  - Penn Medicine Biobank
  - Cancer risk
  - GWAS
  - Polygenic risk score
  - PRS
---

This post shows the initial R script I've written to calculate AUC and OR for the PRS generated in plink in previous blog posts. 

I've pasted the script below and I'll update it a bit later:

```
#!/usr/bin/env Rscript
library(pROC)
library(ggplot2)
library(scales)
library(tidyverse)
library(dplyr)
library(lme4)
library(sjPlot)

# Script takes multiple arguments, all in the form of file paths
  # Arg 1: population covariate file location
  # Arg 2: PMBB Ids of cancer cases
  # Arg 3: PMBB Ids of control cases
  # Arg 4: .Profile file generated in plink using OC_build_PRS
  # Arg 5: Cancer type
  # Arg 6: Output filepath and name

# The script outputs a csv file with the following columns
  # Cancer subtype
  # Odds ratio of the PRS
  # Odds ratio confidence interval
  # AUC of the PRS ROC
  # Confidence interval of AUC of the PRS ROC, bootstrapped x2000
  # AUC of the Principal components only (PC) ROC
  # Confidence interval of AUC of the PC ROC, bootstrapped x2000
  # Change in AUC in PRS model compared to PC model, bootstrapped x2000
  # P value of Change in AUC in PRS model compared to PC model

args=commandArgs(trailingOnly = TRUE)

# Temporary args while working on script
args=c("G://My Drive//Work//Research//Maxwell//phenotypes//OC_covariate_file.txt","G://My Drive//Work//Research//Maxwell//PMBB_IDs//PMBB_IDs_lung_cancer.txt","G://My Drive//Work//Research//Maxwell//PMBB_IDs//PMBB_IDs_controls.txt", "G://My Drive//Work//Research//Maxwell//Profiles//lung_cancer_AFR.profile", "lung_cancer_AFR", "G://My Drive//Work//Research//Maxwell//lung_cancer_AFR.csv")

# read covariates file and name columns 
covariates <- read.csv(file= args[1], header = T, sep="\t")
colnames(covariates)[1] = "id"

# Subset population to only those with age 50-80
covariates = covariates[covariates$BIRTH_YEAR>1942,]
covariates = covariates[covariates$BIRTH_YEAR<1972,]
# Remove patients who are already eligible for CT screening based on smoking hx
covariates = covariates[covariates$CT_ELIGIBLE=="NO",]

# Load "cases" PMBB_ID file
case_phenotypes <- read.csv(file= args[2], header = F, sep=",")
colnames(case_phenotypes)[1] = "id"
case_phenotypes$pheno=1

# Load "control" PMBB_ID file
control_phenotypes <- read.csv(file= args[3], header = F, sep=",")
colnames(control_phenotypes)[1] = "id"
control_phenotypes$pheno=0

phenotypes = rbind(case_phenotypes, control_phenotypes)

# genotype file = .profile generated from PLINK
genotypes <- read.csv(file=args[4], header = T, sep = "")
colnames(genotypes)[1] <- c("id")

# scale genotype file 
genotypes_scaled <- data.frame(genotypes[2], (apply(genotypes[6],2,scale)))
colnames(genotypes_scaled)[1] = "id"
colnames(genotypes_scaled)[2] <- "normalizedScore"

# merge genotype file with phenotype file based on id column
score_pheno = merge(phenotypes, genotypes_scaled, by="id")

# merge score_pheno file with covariates based on id column
score_pheno_cov = merge(score_pheno, covariates, by="id")

# Remove incomplete cases
score_pheno_cov <- score_pheno_cov[complete.cases(score_pheno_cov),]

# for non-gender specific cancers:
mod_PRS <- glm(pheno ~ normalizedScore+Sex+BIRTH_YEAR+PACK_YR_HX+BMI+Exome_PC1+Exome_PC2+Exome_PC3+Exome_PC4+Exome_PC5+Exome_PC6+Exome_PC7+Exome_PC8+Exome_PC9+Exome_PC10, family="binomial", data=score_pheno_cov)

mod_PC <- glm(pheno ~ Sex+BIRTH_YEAR+PACK_YR_HX+BMI+Exome_PC1+Exome_PC2+Exome_PC3+Exome_PC4+Exome_PC5+Exome_PC6+Exome_PC7+Exome_PC8+Exome_PC9+Exome_PC10, family="binomial", data=score_pheno_cov)

# AUC calculated using predict() and roc() for PRS model
predict_mod_PRS <- predict(mod_PRS,type=c("response"))
roc_mod_PRS <- roc(score_pheno_cov$pheno ~ predict_mod_PRS)

# AUC calculated using predict() and roc() for PC model
predict_mod_PC <- predict(mod_PC,type=c("response"))
roc_mod_PC <- roc(score_pheno_cov$pheno ~ predict_mod_PC)

# AUC and bootstrapped CI of the predict_mod_PRS 
auc_mod_PRS <-roc(score_pheno_cov$pheno ~ predict_mod_PRS, score_pheno_cov, plot=T, ci=T,print.auc = TRUE)
CI_bootstrap_PRS <- ci.auc(auc_mod_PRS, method='bootstrap', n.boot=10000)

# AUC and bootstrapped CI of the predict_mod_PC
auc_mod_PC <-roc(score_pheno_cov$pheno ~ predict_mod_PC, score_pheno_cov, plot=T, ci=T,print.auc = TRUE)
CI_bootstrap_PC <- ci.auc(auc_mod_PC, method='bootstrap', n.boot=10000)

# Compare two models
compare_PRS_PC <- roc.test(auc_mod_PRS, auc_mod_PC, method='bootstrap', are.paired=T, boot.n=10000)

# Save output values to variable
options(digits = 4)
OR_PRS = round(exp(summary(mod_PRS)$coefficients[2]),4)
OR_PRS_CI <- paste(round(exp((summary(mod_PRS)$coefficients[2])-1.96*summary(mod_PRS)$coefficients[2,2]),4), "-", round(exp((summary(mod_PRS)$coefficients[2])+1.96*summary(mod_PRS)$coefficients[2,2]),4))

AUC_PRS <- round(as.numeric(auc(roc_mod_PRS)),4)
AUC_PRS_CI <- paste(round(as.numeric(CI_bootstrap_PRS)[1],4), "-", round(as.numeric(CI_bootstrap_PRS)[3],4))

AUC_PC <- round(as.numeric(auc(roc_mod_PC)),4)
AUC_PC_CI <- paste(round(as.numeric(CI_bootstrap_PC)[1],4), "-", round(as.numeric(CI_bootstrap_PC)[3],4))

delta_AUC_PRS_PC <- round(AUC_PRS-AUC_PC,4)
p_value_delta <- round(compare_PRS_PC$p.value,4)

# Create output file that will be written to csv
# 4 Columns labelled for AUC, AUC confidence interval, odds ratio, and odds ratio CI
output = data.frame(Subset=args[5], OR_PRS=OR_PRS, OR_PRS_CI=OR_PRS_CI, AUC_PRS=AUC_PRS, AUC_PRS_CI=AUC_PRS_CI, AUC_PC=AUC_PC, AUC_PC_CI=AUC_PC_CI, delta_AUC_PRS_PC=delta_AUC_PRS_PC, p_value_delta=p_value_delta, n_cases=length(which(score_pheno_cov$pheno==1)), n_controls=length(which(score_pheno_cov$pheno==0)), n_snps=max(genotypes$CNT)/2 )

# Output to CSV with file path as specified in args
write.csv(output,args[6], row.names = FALSE, quote=FALSE)
```
